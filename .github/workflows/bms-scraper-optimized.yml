name: BMS Scraper - Optimized (Every 30 Minutes)

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual triggering
  repository_dispatch: # Allow external API triggering
    types: [scrape]

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Increased timeout to account for potential cache misses
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(node -p "require('./package-lock.json').packages['node_modules/playwright'].version")" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --only=production

      - name: Install Playwright browsers (if not cached)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: Install system dependencies only (if browsers cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run optimized BMS scraper
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          BMS_USERNAME: ${{ secrets.BMS_USERNAME }}
          BMS_PASSWORD: ${{ secrets.BMS_PASSWORD }}
          NODE_OPTIONS: '--no-experimental-fetch'
        run: |
          echo "ğŸš€ Starting optimized BMS scraper at $(date)"
          echo "ğŸ“Š Target: Global Youth Festival 2025 data"
          echo "ğŸ”§ Environment check:"
          echo "  - MongoDB URI: ${MONGODB_URI:0:20}..." 
          echo "  - BMS Username: $BMS_USERNAME"
          echo "  - BMS Password: ${BMS_PASSWORD:0:3}***"
          timeout 600 npm run scrape || echo "âš ï¸ Scraper timed out after 10 minutes"
          echo "âœ… Scraper completed at $(date)"

      - name: Upload debug artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bms-debug-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            debug-*.html
            debug-*.png
            *.log
          retention-days: 3 # Shorter retention to save storage

      - name: Performance summary
        if: always()
        run: |
          echo "ğŸ“ˆ Workflow Performance Summary:"
          echo "â° Started: $(date -d '@${{ github.event.head_commit.timestamp }}' 2>/dev/null || echo 'Manual trigger')"
          echo "ğŸ”„ Run #${{ github.run_number }}, Attempt #${{ github.run_attempt }}"
          echo "ğŸ’¾ Check MongoDB for latest data in collections: eventsummaries, registrationdetails"
